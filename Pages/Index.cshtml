@page
@model IndexModel
@{
    ViewData["Title"] = "Othello";
    <link rel="stylesheet" href="~/css/style.css" />
}

@* @page
@model YourNamespace.Pages.PlayerModel
@{
    ViewData["Title"] = "Setup Player";
} *@
<!-- Welcome Page + Loading Screen -->
<div id="welcome-page" class="welcome-page">
    <!-- Loading overlay -->
    <div id="loading-screen" class="loading-screen">
        <img src="~/images/othello-logo.png" alt="Othello Logo" class="logo" />
        <div class="loader"></div>
    </div>

    <!-- Main content -->
    <div class="welcome-content hidden">
        <img src="~/images/othello-board.png" alt="Othello Board" class="board-img" />
        <h1>🎮 Welcome to Othello!</h1>
        <p>Challenge your friend and enjoy the game.</p>
        <button onclick="showPlayerForm()">Start Game</button>
    </div>

    <!-- Animated background circles -->
    <div class="bg-circles">
        <span></span><span></span><span></span><span></span><span></span>
        <span></span><span></span><span></span><span></span><span></span>
    </div>
</div>

<style>
/* Base styles */
body { margin:0; font-family:'Segoe UI', sans-serif; background:#121212; color:#fff; }
.hidden { display:none !important; }

/* Welcome Page */
.welcome-page { position:relative; height:100vh; overflow:hidden; display:flex; justify-content:center; align-items:center; flex-direction:column; background: linear-gradient(135deg,#1e1e1e,#2c2c2c); text-align:center; }
.welcome-content { position:relative; z-index:10; animation: fadeIn 1.5s ease forwards; }
.welcome-content h1 { font-size:3rem; margin:1rem 0; animation: floatText 3s ease-in-out infinite alternate; }
.welcome-content p { font-size:1.2rem; color:#ccc; margin-bottom:2rem; }
.welcome-content button { background:#ff9900; border:none; padding:1rem 2rem; font-size:1.2rem; font-weight:bold; border-radius:0.5rem; cursor:pointer; transition:transform 0.3s, box-shadow 0.3s; }
.welcome-content button:hover { transform:scale(1.1); box-shadow:0 0 20px #ff9900; }

/* Othello board image */
.board-img { width:200px; margin-bottom:1rem; animation: bounce 2s infinite alternate; }

/* Loading screen */
.loading-screen { position:absolute; top:0; left:0; width:100%; height:100%; background:#121212; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:20; }
.loading-screen .logo { width:150px; margin-bottom:1rem; }
.loader { border:4px solid #333; border-top:4px solid #ff9900; border-radius:50%; width:50px; height:50px; animation: spin 1s linear infinite; }

/* Animated background circles */

</style>

<script>
const loadingScreen = document.getElementById("loading-screen");
const welcomeContent = document.querySelector(".welcome-content");
const formPage = document.getElementById("player-form");

// Simulate loading
window.addEventListener("DOMContentLoaded", () => {
    setTimeout(() => {
        loadingScreen.classList.add("hidden");
        welcomeContent.classList.remove("hidden");
    }, 2000); // 2 detik loading
});

function showPlayerForm() {
    welcomeContent.classList.add("hidden");
    formPage.classList.remove("hidden");
}
</script>



<div id="player-form" class=" container d-flex justify-content-center align-items-center vh-100" style="display:none;">
    <div class="card shadow-lg border-0 rounded-4 p-4" style="max-width:500px; width:100%;">
        
        <div class="text-center mb-4">
            <h3 class="fw-bold">🎮 Setup Players</h3>
            <p class="text-muted">Masukkan nama pemain untuk mulai game</p>
        </div>

        <form method="post" onsubmit="onSubmit(event)">
            <div class="mb-3">
                <label class="form-label fw-semibold">⚫ Player 1 (Black)</label>
                <input type="text" name="Player1" id="player1" class="form-control form-control-md"
                       placeholder="Masukkan nama Player 1" required />
            </div>

            <div class="mb-4">
                <label class="form-label fw-semibold">⚪ Player 2 (White)</label>
                <input type="text" name="Player2" id="player2" class="form-control form-control-md fs-12 fw-semibold"
                       placeholder="Masukkan nama Player 2" required />
            </div>

            <div class="d-grid">
                <button type="submit"  class="btn btn-dark btn-lg rounded-3">
                    🚀 Mulai Game
                </button>
            </div>
        </form>

    </div>
</div>

<div id="game-board" class="hidden d-flex flex-column justify-content-center align-items-center bg-black" style="display:none;">
    <h2 class="fw-bold text-white">Othello</h2>
    
   <div class="score-card mb-3">

    <div id="player1Card" class="player-half">
        <div class="player-name" id="player1Name">-</div>
        <div class="score" id="player1Score">0</div>
    </div>

    <div id="player2Card" class="player-half">
        <div class="player-name" id="player2Name">-</div>
        <div class="score" id="player2Score">0</div>
    </div>

</div>


   
   <div class="d-flex">
        <div class="mt-3 text-center">
            <button class="btn-pass" onclick="passTurn()">
                Pass
            </button>
        </div>
        <div id="board" class="board"></div>
        <div class="mt-3 text-center">
            <button class="btn-pass" onclick="passTurn()">
                Pass
            </button>
        </div>

    @* Toas invalid move *@
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="invalidMoveToast" class="toast text-bg-danger border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body">
                Invalid move! Pilih posisi yang valid.
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<div id="gameOverlay" class="game-overlay d-none">
    <div class="game-result-card">
        <h1 id="resultTitle">⚫ Black Wins!</h1>
        <p id="resultScore">40 - 24</p>

        <div class="result-buttons">
            <button onclick="startGame()">🔁 Play Again</button>
            <button onclick="goToMenu()">🏠 Menu</button>
        </div>
    </div>
</div>

</div>



<script>



    const form = document.getElementById("player-form");
    const board = document.getElementById("game-board");
    const boardDiv = document.getElementById("board");

    const player1NameSpan = document.getElementById("player1Name");
    const player2NameSpan = document.getElementById("player2Name");


let players = []; // array [player1Name, player2Name]
let playerColors = {}; // mapping warna per nama

async function onSubmit(e) {
    e.preventDefault();
    let p1 = document.getElementById("player1").value;
    let p2 = document.getElementById("player2").value;

    players = [p1, p2];
    localStorage.setItem("players", JSON.stringify(players));

    form.classList.add("hidden");
    board.classList.remove("hidden");

    await startGame(players);
}

async function startGame(playersInput) {
    let p1, p2;

    if (playersInput && Array.isArray(playersInput)) {
        // dipanggil dari reload
        [p1, p2] = playersInput;
    } else {
        // dipanggil dari form submit
        p1 = document.getElementById("player1").value;
        p2 = document.getElementById("player2").value;
    }

    const res = await fetch("http://localhost:5002/Othello/start", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ Player1: p1, Player2: p2 })
    });

    if (!res.ok) {
        console.error("Failed to start game", await res.text());
        return;
    }

    const data = await res.json();

    if (!data.currentPlayer || !data.players) {
        console.error("Invalid backend response", data);
        return;
    }

    const current = data.currentPlayer.name;
    const opponent = data.players.find(p => p.name !== current).name;

    playerColors = {};
    data.players.forEach(p => playerColors[p.name] = p.color);

    player1NameSpan.innerText = `⚫ ${current}`;
    player2NameSpan.innerText = `⚪ ${opponent}`;

    board.classList.remove("hidden");
    form.classList.add("hidden");

    await loadStatus();
    document.getElementById("gameOverlay").classList.add("d-none");
}

async function loadStatus() {
    await loadBoard();

    const statusRes = await fetch("http://localhost:5002/Othello/status");
    if (!statusRes.ok) {
        console.error("Error loading status:", await statusRes.text());
        return;
    }

    const data = await statusRes.json();
    const currentPlayer = data.currentPlayer;
    const validMoves = data.validMoves ?? [];
    const scores = data.score ?? { Black: 0, White: 0 };
    const isGameOver = data.isGameOver ?? false;
    
    const boardData = data.board ?? data; 
    if (!boardData || !boardData.size || !boardData.cells) {
        console.error("Board data kosong!", boardData);
        return; 
}

    if (!currentPlayer) return;

    // update player card highlight
    document.getElementById("player1Card").classList.toggle("active", currentPlayer.color === "Black");
    document.getElementById("player2Card").classList.toggle("active", currentPlayer.color === "White");

    // highlight valid moves
    for (const pos of validMoves) {
        const index = pos.row * boardData.size + pos.col;
        if (boardDiv.children[index]) boardDiv.children[index].classList.add("valid-move");
    }

    // update score dinamis
   const playerDivs = document.querySelectorAll(".score-card .player-half");

for (let div of playerDivs) {
    const nameSpan = div.querySelector(".player-name");
    const scoreSpan = div.querySelector(".score");

    if (nameSpan && scoreSpan) {
        const playerName = nameSpan.innerText
            .replace("⚫ ", "")
            .replace("⚪ ", "")
            .trim();

        const color = playerColors[playerName];

        scoreSpan.innerText =
            color === "Black"
                ? scores.black
                : scores.white;
    }
}


    // jika game over
    if (isGameOver) {
        const winner = scores.Black > scores.White ? "black" :
                       scores.White > scores.Black ? "white" : "draw";
        showGameResult(winner, scores.Black, scores.White);
    }
}

async function loadBoard() {
    const statusRes = await fetch("http://localhost:5002/Othello/board");
    if (!statusRes.ok) {
        console.error("Error loading board:", await statusRes.text());
        return;
    }

    const boardData = await statusRes.json();
    boardDiv.innerHTML = "";

    for (let r = 0; r < boardData.size; r++) {
        for (let c = 0; c < boardData.size; c++) {
            const cell = boardData.cells[r][c];
            const cellDiv = document.createElement("div");
            cellDiv.className = "cell";
            if (cell.piece) {
                cellDiv.innerHTML = `<div class="${cell.piece.color.toLowerCase()}"></div>`;
            }
            cellDiv.addEventListener("click", () => play(r, c));
            boardDiv.appendChild(cellDiv);
        }
    }
}

async function play(row, col) {
    const res = await fetch("http://localhost:5002/Othello/play", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ row, col })
    });

    if (!res.ok) {
        highlightInvalidCell(row, col);
        showInvalidMoveToast();
        return;
    }
    await loadStatus();
}

async function passTurn() {
    await fetch("http://localhost:5002/Othello/pass", { method: "POST" });
    await loadStatus();
}

window.addEventListener("DOMContentLoaded", async () => {
    const savedPlayers = JSON.parse(localStorage.getItem("players"));
    if (Array.isArray(savedPlayers) && savedPlayers.length === 2) {
        await startGame(savedPlayers);
    } else {
        form.classList.remove("hidden");
        board.classList.add("hidden");
    }
});


</script>
